#ESTIMATION
@estimator Bayes
@max_iters 300
@max_evals 1000
@grad_tol 0.002  #The default is 0.002

@MCMC
start 0
length 20000000
keep 4000
burn_in 500
systematic true
stepsize 0.02
adaptive_stepsize true
adapt_at 15000 50000 100000 200000 300000 400000
#adapt_at must be less than burn_in*1000
proposal_t true
df 4


@profile
parameter initialization.B0
n 15 # number of values calculated to create the profile
l 40000
u 150000


#OBSERVATIONS

# Commercial trawl fishery catch-at-age
@catch_at wcsiTRLage
years 1991 1994 1995 1996 1997 1998 1999 2000 2001 2002 2003 2004 2005 2006 2007 2008 2012 2013 2014 2015 2016 2017 2018 2019
fishery wcsiTRL
sum_to_one 1
plus_group 1
sexed False
min_class 4 
max_class 21 
#Age  A4 A5 A6 A7 A8 A9 A10 A11 A12 A13 A14 A15 A16 A17 A18 A19 A20 A21+
1991 0.00190 0.00867 0.01289 0.01899 0.05611 0.04980 0.09025 0.08281 0.15009 0.18811 0.07258 0.05073 0.09159 0.05713 0.03708 0.01445 0.01586 0.00099
1994 0.00774 0.01834 0.03519 0.06850 0.10194 0.10772 0.11276 0.12120 0.07918 0.08546 0.08528 0.08585 0.02536 0.01747 0.02009 0.01457 0.01032 0.00302
1995 0.01682 0.06364 0.06187 0.10948 0.15091 0.13745 0.07993 0.08568 0.06677 0.05543 0.05655 0.04224 0.02936 0.02177 0.00748 0.00721 0.00450 0.00290
1996 0.00175 0.02373 0.08429 0.07405 0.11041 0.14819 0.10401 0.09993 0.08899 0.10259 0.06099 0.03557 0.03219 0.00723 0.01149 0.00782 0.00677 0.00000
1997 0.00172 0.01238 0.04817 0.06349 0.07279 0.10586 0.11388 0.10996 0.13421 0.11345 0.07241 0.04830 0.03144 0.02062 0.02124 0.01856 0.01020 0.00131
1998 0.00187 0.02442 0.03365 0.03736 0.10008 0.19730 0.14055 0.12717 0.12265 0.06701 0.06402 0.01898 0.01159 0.01773 0.00617 0.01715 0.01091 0.00139
1999 0.01395 0.02963 0.03469 0.04730 0.12594 0.15679 0.15394 0.13980 0.10340 0.06041 0.04597 0.02203 0.02272 0.00636 0.01647 0.00946 0.00344 0.00770
2000 0.00982 0.01811 0.02869 0.04870 0.15018 0.05903 0.22023 0.10302 0.09964 0.11077 0.03326 0.04125 0.01814 0.01881 0.01132 0.01375 0.00854 0.00673
2001 0.01403 0.05539 0.05447 0.04465 0.07120 0.10739 0.12627 0.13957 0.11291 0.07687 0.08282 0.03548 0.03621 0.01367 0.00624 0.01159 0.00570 0.00555
2002 0.01761 0.03694 0.05798 0.04007 0.11669 0.09607 0.10487 0.13252 0.12371 0.09777 0.06563 0.04098 0.02013 0.01725 0.01262 0.00741 0.00217 0.00957
2003 0.03285 0.09148 0.06727 0.06107 0.08623 0.07676 0.09691 0.10441 0.11960 0.09167 0.05864 0.03511 0.02532 0.01650 0.01271 0.01781 0.00441 0.00125
2004 0.03044 0.05463 0.07834 0.07430 0.09378 0.07818 0.06886 0.09857 0.12863 0.10116 0.08263 0.05063 0.02557 0.01746 0.00664 0.00703 0.00305 0.00013
2005 0.06786 0.07488 0.05466 0.05324 0.07123 0.07800 0.08967 0.08949 0.07987 0.07353 0.05728 0.07257 0.05404 0.03832 0.01783 0.01408 0.01324 0.00020
2006 0.04941 0.11833 0.07980 0.05919 0.06561 0.06954 0.08769 0.09019 0.08653 0.06736 0.05295 0.04615 0.05109 0.04139 0.01866 0.01380 0.00231 0.00000
2007 0.02471 0.05575 0.05967 0.12260 0.06730 0.09709 0.06128 0.08146 0.07874 0.10000 0.06518 0.04571 0.06999 0.03456 0.01691 0.00698 0.01158 0.00052
2008 0.03857 0.11832 0.05367 0.08796 0.08936 0.06328 0.06939 0.07502 0.07631 0.09375 0.05248 0.05299 0.04412 0.02921 0.03479 0.01599 0.00246 0.00233
2012 0.02153 0.02233 0.03019 0.05714 0.09593 0.12944 0.13836 0.13280 0.08538 0.05941 0.04983 0.04225 0.03028 0.01933 0.02948 0.02200 0.02201 0.01232
2013 0.07960 0.05844 0.03481 0.04457 0.10696 0.13966 0.13739 0.09946 0.09821 0.07314 0.04187 0.02345 0.01526 0.00953 0.01128 0.00933 0.00995 0.00710
2014 0.03437 0.05470 0.05906 0.06302 0.06774 0.12645 0.15767 0.10468 0.10847 0.07002 0.03134 0.04810 0.01431 0.01805 0.01359 0.01567 0.00000 0.01273
2015 0.07272 0.10689 0.04409 0.04556 0.06184 0.09957 0.10100 0.07980 0.10410 0.07821 0.05559 0.06646 0.03137 0.01527 0.01568 0.00510 0.01058 0.00617
2016 0.03036 0.03594 0.02333 0.03050 0.06172 0.08060 0.11638 0.10706 0.13661 0.10345 0.10016 0.05286 0.03012 0.04301 0.01970 0.01236 0.00516 0.01067
2017 0.07164 0.07809 0.03580 0.02554 0.07583 0.05022 0.09831 0.08444 0.07929 0.08674 0.10079 0.08403 0.04382 0.02961 0.03228 0.00873 0.00781 0.00701
2018 0.03448 0.05082 0.04179 0.05240 0.07098 0.06187 0.07361 0.09580 0.12667 0.08312 0.10279 0.07914 0.03835 0.01930 0.02899 0.01372 0.00972 0.01647
2019 0.04729 0.03462 0.03145 0.04188 0.09365 0.08723 0.12274 0.11380 0.11253 0.09054 0.06927 0.06527 0.03296 0.01637 0.01194 0.01082 0.01004 0.00760
N_1991 33
N_1994 39
N_1995 51
N_1996 30
N_1997 80
N_1998 56
N_1999 56
N_2000 43
N_2001 43
N_2002 78
N_2003 66
N_2004 85
N_2005 66
N_2006 36
N_2007 21
N_2008 45
N_2012 36
N_2013 70
N_2014 26
N_2015 101
N_2016 74
N_2017 70
N_2018 65
N_2019 69
ageing_error True
dist multinomial
r 0.000001

# Data from 2018 from O'Driscoll and Ballara - trawl and acoustic survey of hoki and middle depth fish, FAR 2019/19
# Added to the older section of the CASAL estimation.csl file

# Tangaroa middle depths biomass survey series core ares(2012 survey stratum areas: strata 12A,B,C, and 4A,B,C))
@relative_abundance wcsiTANbio
step 2
proportion_mortality 0.5
area home
biomass 1
ogive wcsiTANsel
q wcsiTAN
years 2000 2012 2013 2016 2018
2000 1861
2012 2169
2013 2000
2016 1635
2018 1682
cv_2000 0.173
cv_2012 0.148
cv_2013 0.184
cv_2016 0.127
cv_2018 0.183
cv_process_error 0.20
dist lognormal

# Commercial line fishery catch-at-age # 2006 and 2007 added in 2017, along with 2015
@catch_at wcsiLLNage
years 2003 2006 2007 2012 2015
fishery wcsiLLN
sum_to_one 1
plus_group 1
sexed False
min_class 5 
max_class 23 # plus group reduced by one age to remove the zero in the plus group for 2015
#Age	5	6	7	8	9	10	11	12	13	14	15	16	17	18	19	20	21	22	23+	
2003	0.0001	0.0009	0.0199	0.0321	0.0401	0.0592	0.0915	0.1266	0.1053	0.0871	0.0644	0.0555	0.0633	0.0452	0.0306	0.0216	0.0102	0.0080	0.1384	
2006	0.0105	0.0312	0.0667	0.1040	0.1134	0.1124	0.1359	0.0919	0.0528	0.0559	0.0603	0.0568	0.0404	0.0247	0.0163	0.0044	0.0088	0.0020	0.0115	
2007	0.0106	0.0210	0.0519	0.0258	0.0839	0.0618	0.0705	0.0646	0.0583	0.0508	0.0385	0.1286	0.0240	0.0994	0.0125	0.0075	0.0457	0.0644	0.0802	
2012	0.0001	0.0001	0.0064	0.0241	0.0395	0.0580	0.0735	0.0792	0.0725	0.0775	0.0737	0.0947	0.0562	0.0703	0.0811	0.0502	0.0551	0.0303	0.0574	
2015	0.0000	0.0000	0.0086	0.0401	0.1038	0.1192	0.1617	0.1872	0.1340	0.0885	0.0443	0.0301	0.0294	0.0206	0.0097	0.0104	0.0083	0.0002	0.0040	
# rule of thumb, these are set to be one third of the mean of the trawl fishery ones. n_trips factor is 0.25, n_sets/twos factor is 0.42
# now one quarter
N_2003 4 
N_2006 7
N_2007 7
N_2012 10 
N_2015 7
ageing_error True
dist multinomial
r 0.000001

# Tangaroa random bottom trawl survey (strata 12A,B,C, and 4A,B,C)
@proportions_at Tangaroa_propn_at_age_Aug
years 2000 2012 2013 2016
step 2
proportion_mortality 0.5
area home
sexed False
plus_group 1
sum_to_one 1
min_class 3 
max_class 23 
ogive wcsiTANsel
#Age	3	4	5	6	7	8	9	10	11	12	13	14	15	16	17	18	19	20	21	22	23+
2000	0.0210	0.0433	0.0476	0.0355	0.0317	0.1025	0.0608	0.2001	0.0944	0.0794	0.1029	0.0283	0.0390	0.0194	0.0247	0.0115	0.0196	0.0062	0.0044	0.0125	0.0153
2012	0.0436	0.0477	0.0431	0.0275	0.0500	0.0607	0.0761	0.0962	0.0865	0.0718	0.0601	0.0544	0.0418	0.0372	0.0187	0.0450	0.0357	0.0266	0.0226	0.0203	0.0345
2013	0.0339	0.0728	0.0483	0.0305	0.0435	0.0838	0.1055	0.1294	0.0791	0.0896	0.0721	0.0456	0.0241	0.0224	0.0141	0.0228	0.0225	0.0204	0.0127	0.0107	0.0161
2016	0.0290	0.0730	0.0574	0.0297	0.0439	0.0653	0.0712	0.0976	0.0916	0.1253	0.0669	0.0725	0.0442	0.0116	0.0339	0.0129	0.0086	0.0097	0.0118	0.0072	0.0366
2018 0.0527 0.0351 0.0325 0.0443 0.0327 0.0480 0.0419 0.0634 0.1018 0.1177 0.0864 0.0955 0.0906 0.0454 0.0200 0.0390 0.0133 0.0114 0.0051 0.0104 0.0127
# rule of thumb, set to 0.33 times the number of otoliths read. This makes it about 10 times the weight of the trawl fishery obs
N_2000 85 # n = 560; was 185
N_2012 93 # n=603; 202
N_2013 79 # n = 519; 171
N_2016 69 # n = 453; 149
N_2018 160 # n = 487
ageing_error True
dist multinomial
r 0.000001


# RELATIVITY CONSTANTS
#@q_method nuisance
@q_method free

@q wcsiTRLcpue
q 1e-5

@q wcsiTAN
q 0.3

# FREE PARAMETERS

@estimate
parameter q[wcsiTAN].q
#lower_bound 1e-8
#upper_bound 5
#prior uniform
mu 0.07
cv 0.7
lower_bound 0.001
upper_bound 1
prior lognormal
# Estimated as for Chat & SubA surveys, but with with mu x 0.56 to account for WCSI areas not surveyed


@estimate
parameter q[wcsiTRLcpue].q
lower_bound 1e-8
upper_bound 1e-3
prior uniform-log

@estimate
parameter initialization.B0
lower_bound 10000
upper_bound 500000
prior uniform-log

{
@estimate
parameter natural_mortality.all
# prior expert opinion was 0.14-0.25 with mu 0.2, but this is as close as i can esily get given a symetrical distribution (0.15-0.25, mu 0.2)
prior normal-by-stdev
mu 0.2
stdev 0.025 
lower_bound 0.05
upper_bound 0.5
}

@estimate
parameter selectivity[wcsiTANsel].mature
lower_bound 0.1  0.1 0.1
upper_bound 100 200 200
prior uniform

@estimate
phase 2
parameter selectivity[wcsiTANsel].immature
lower_bound 3  1 0.001
upper_bound 3  1 1
prior uniform

@estimate
parameter selectivity[wcsiTRLsel].all
lower_bound 0  0.1  0.1 
upper_bound 50 200 200
prior uniform

@estimate
parameter selectivity[wcsiLLNsel].all
lower_bound 1  1
upper_bound 20 200
prior uniform


@estimate
parameter recruitment.YCS
#YCS_years     1968 1969 1970 1971 1972 1973 1974 1975 1976 1977 1978 1979 1980 1981 1982 1983 1984 1985 1986 1987 1988 1989 1990 1991 1992 1993 1994 1995 1996 1997 1998 1999 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014 2015 2016
lower_bound       1    1    1    1    1    1 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01 0.01    1    1    1    1
upper_bound       1    1    1    1    1    1  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100  100 100  100  100  100   100    1    1    1    1
prior lognormal
mu                1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1    1  1  1    1   1    1  1    1   1    1
cv              0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7  0.7 0.7  0.7 0.7  0.7 0.7  0.7

# Need this section in a B0 run, but not a Bmean run
@vector_average_penalty
label YCS_average_1
vector recruitment.YCS
k 1
multiplier 6

# removing ageing error tidies up the 1st 2 YCS fits to obs in the 2012 TAN AFs
@ageing_error
type normal
c 0.1

@catch_limit_penalty
label clp1
fishery wcsiTRL
log_scale 1
multiplier 10000

@catch_limit_penalty
label clp2
fishery wcsiLLN
log_scale 1
multiplier 10000

